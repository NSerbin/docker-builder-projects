name: Build Docker Image

on:
  repository_dispatch:
    types: [builder.build]
  workflow_dispatch:
    inputs:
      repo_name:
        description: "Repo name (must exist in projects.yml)"
        required: true
        type: string
      source_repo:
        description: "ORG/REPO"
        required: true
        type: string
      ref:
        description: "Git ref (branch / tag / sha)"
        required: false
        default: "main"

permissions:
  contents: write
  packages: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      repo_name: ${{ steps.cfg.outputs.repo_name }}
      source_repo: ${{ steps.cfg.outputs.source_repo }}
      ref: ${{ steps.cfg.outputs.ref }}

      registry: ${{ steps.cfg.outputs.registry }}
      platforms: ${{ steps.cfg.outputs.platforms }}

      web_image_name: ${{ steps.cfg.outputs.web_image_name }}
      web_df_mode: ${{ steps.cfg.outputs.web_df_mode }}
      web_df_path: ${{ steps.cfg.outputs.web_df_path }}
      web_context: ${{ steps.cfg.outputs.web_context }}

      caddy_image_name: ${{ steps.cfg.outputs.caddy_image_name }}
      caddy_df_mode: ${{ steps.cfg.outputs.caddy_df_mode }}
      caddy_df_path: ${{ steps.cfg.outputs.caddy_df_path }}
      caddy_context: ${{ steps.cfg.outputs.caddy_context }}

      docker_tag: ${{ steps.tag.outputs.docker_tag }}

      helm_enabled: ${{ steps.cfg.outputs.helm_enabled }}
      charts_repo: ${{ steps.cfg.outputs.charts_repo }}
      charts_ref: ${{ steps.cfg.outputs.charts_ref }}
      chart_path: ${{ steps.cfg.outputs.chart_path }}
      values_file: ${{ steps.cfg.outputs.values_file }}
      update_app_version: ${{ steps.cfg.outputs.update_app_version }}
      helm_updates_json: ${{ steps.cfg.outputs.helm_updates_json }}

    steps:
      - uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - id: cfg
        name: Load project config
        env:
          REPO_NAME: ${{ github.event.client_payload.repo_name || github.event.inputs.repo_name }}
          SOURCE_REPO: ${{ github.event.client_payload.source_repo || github.event.inputs.source_repo }}
          REF: ${{ github.event.client_payload.ref || github.event.inputs.ref }}
        run: |
          set -euo pipefail

          if ! yq -e ".projects.${REPO_NAME}" projects.yml >/dev/null; then
            echo "Project ${REPO_NAME} not found in projects.yml"
            exit 1
          fi

          REGISTRY="$(yq -r ".projects.${REPO_NAME}.docker.registry" projects.yml)"
          PLATFORMS="$(yq -r ".projects.${REPO_NAME}.docker.platforms" projects.yml)"

          WEB_IMAGE="$(yq -r ".projects.${REPO_NAME}.docker.images.web.image_name" projects.yml)"
          WEB_DF_MODE="$(yq -r ".projects.${REPO_NAME}.docker.images.web.dockerfile.mode" projects.yml)"
          WEB_DF_PATH="$(yq -r ".projects.${REPO_NAME}.docker.images.web.dockerfile.path" projects.yml)"
          WEB_CONTEXT="$(yq -r ".projects.${REPO_NAME}.docker.images.web.build.context" projects.yml)"

          CADDY_IMAGE="$(yq -r ".projects.${REPO_NAME}.docker.images.caddy.image_name" projects.yml)"
          CADDY_DF_MODE="$(yq -r ".projects.${REPO_NAME}.docker.images.caddy.dockerfile.mode" projects.yml)"
          CADDY_DF_PATH="$(yq -r ".projects.${REPO_NAME}.docker.images.caddy.dockerfile.path" projects.yml)"
          CADDY_CONTEXT="$(yq -r ".projects.${REPO_NAME}.docker.images.caddy.build.context" projects.yml)"

          HELM_ENABLED_RAW="$(yq -r ".projects.${REPO_NAME}.helm.enabled // false" projects.yml)"
          HELM_ENABLED="false"
          [ "$HELM_ENABLED_RAW" = "true" ] && HELM_ENABLED="true"

          CHARTS_REPO="$(yq -r ".projects.${REPO_NAME}.helm.charts_repo // \"\"" projects.yml)"
          CHARTS_REF="$(yq -r ".projects.${REPO_NAME}.helm.charts_ref // \"main\"" projects.yml)"
          CHART_PATH="$(yq -r ".projects.${REPO_NAME}.helm.chart_path // \"\"" projects.yml)"
          VALUES_FILE="$(yq -r ".projects.${REPO_NAME}.helm.values_file // \"values.yaml\"" projects.yml)"
          UPDATE_APP_VERSION_RAW="$(yq -r ".projects.${REPO_NAME}.helm.update_app_version // false" projects.yml)"
          UPDATE_APP_VERSION="false"
          [ "$UPDATE_APP_VERSION_RAW" = "true" ] && UPDATE_APP_VERSION="true"

          # updates list -> JSON
          python - <<'PY' > /tmp/updates.json
          import yaml, json
          cfg=yaml.safe_load(open("projects.yml"))
          p=cfg["projects"][r"""'"$REPO_NAME"'"""]
          updates=p.get("helm",{}).get("updates",[])
          print(json.dumps(updates))
          PY

          UPDATES_JSON="$(cat /tmp/updates.json)"

          {
            echo "repo_name=${REPO_NAME}"
            echo "source_repo=${SOURCE_REPO}"
            echo "ref=${REF}"

            echo "registry=${REGISTRY}"
            echo "platforms=${PLATFORMS}"

            echo "web_image_name=${WEB_IMAGE}"
            echo "web_df_mode=${WEB_DF_MODE}"
            echo "web_df_path=${WEB_DF_PATH}"
            echo "web_context=${WEB_CONTEXT}"

            echo "caddy_image_name=${CADDY_IMAGE}"
            echo "caddy_df_mode=${CADDY_DF_MODE}"
            echo "caddy_df_path=${CADDY_DF_PATH}"
            echo "caddy_context=${CADDY_CONTEXT}"

            echo "helm_enabled=${HELM_ENABLED}"
            echo "charts_repo=${CHARTS_REPO}"
            echo "charts_ref=${CHARTS_REF}"
            echo "chart_path=${CHART_PATH}"
            echo "values_file=${VALUES_FILE}"
            echo "update_app_version=${UPDATE_APP_VERSION}"
            echo "helm_updates_json=${UPDATES_JSON}"
          } >> "$GITHUB_OUTPUT"

      - id: tag
        name: Compute docker tag
        run: |
          set -euo pipefail
          REF="${{ steps.cfg.outputs.ref }}"
          if echo "$REF" | grep -Eq '^v?[0-9]+\.[0-9]+\.[0-9]+'; then
            TAG="$REF"
          else
            TAG="sha-$(echo $GITHUB_SHA | cut -c1-7)"
          fi
          echo "docker_tag=${TAG}" >> "$GITHUB_OUTPUT"

  build_web:
    needs: prepare
    uses: NSerbin/gh-pipelines/.github/workflows/docker-build.yml@main
    with:
      registry: ${{ needs.prepare.outputs.registry }}
      repository-name: ${{ needs.prepare.outputs.web_image_name }}
      docker-tag: ${{ needs.prepare.outputs.docker_tag }}
      docker-architecture: ${{ needs.prepare.outputs.platforms }}
      ghcr-owner: nserbin

      clone-source: true
      source-repo: ${{ needs.prepare.outputs.source_repo }}
      source-ref: ${{ needs.prepare.outputs.ref }}

      dockerfile-mode: ${{ needs.prepare.outputs.web_df_mode }}
      dockerfile-path: ${{ needs.prepare.outputs.web_df_path }}
      build-context: ${{ needs.prepare.outputs.web_context }}

      linter-fail: "true"
    secrets: inherit

  build_caddy:
    needs: prepare
    uses: NSerbin/gh-pipelines/.github/workflows/docker-build.yml@main
    with:
      registry: ${{ needs.prepare.outputs.registry }}
      repository-name: ${{ needs.prepare.outputs.caddy_image_name }}
      docker-tag: ${{ needs.prepare.outputs.docker_tag }}
      docker-architecture: ${{ needs.prepare.outputs.platforms }}
      ghcr-owner: nserbin

      clone-source: true
      source-repo: ${{ needs.prepare.outputs.source_repo }}
      source-ref: ${{ needs.prepare.outputs.ref }}

      dockerfile-mode: ${{ needs.prepare.outputs.caddy_df_mode }}
      dockerfile-path: ${{ needs.prepare.outputs.caddy_df_path }}
      build-context: ${{ needs.prepare.outputs.caddy_context }}

      linter-fail: "true"
    secrets: inherit

  update_helm:
    name: Update Helm values (image tags)
    needs: [prepare, build]
    if: ${{ needs.prepare.outputs.helm_enabled == 'true' }}
    uses: NSerbin/gh-pipelines/.github/workflows/helm-update-image-tag.yml@main
    with:
      charts_repo: ${{ needs.prepare.outputs.charts_repo }}
      charts_ref: ${{ needs.prepare.outputs.charts_ref }}
      chart_path: ${{ needs.prepare.outputs.chart_path }}

      updates_json: >-
        [
          {"file":"values.yaml","path":".image.tag","value":"${{ needs.prepare.outputs.docker_tag }}","type":"str"},
          {"file":"values.yaml","path":".caddy.image.tag","value":"${{ needs.prepare.outputs.docker_tag }}","type":"str"}
        ]

      update_app_version: ${{ needs.prepare.outputs.update_app_version }}
      app_version_value: ${{ needs.prepare.outputs.docker_tag }}

      commit_message: "chore(${{ needs.prepare.outputs.repo_name }}): bump images to ${{ needs.prepare.outputs.docker_tag }}"
    secrets:
      SYNC_APP_ID: ${{ secrets.SYNC_APP_ID }}
      SYNC_APP_PRIVATE_KEY: ${{ secrets.SYNC_APP_PRIVATE_KEY }}
