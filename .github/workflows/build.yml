name: Build Docker Images (multi) + Update Helm

on:
  repository_dispatch:
    types: [builder.build]

  workflow_dispatch:
    inputs:
      repo_name:
        required: true
        type: string
      source_repo:
        required: true
        type: string
      ref:
        required: false
        default: main
        type: string

permissions:
  contents: write
  packages: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      repo_name: ${{ steps.base.outputs.repo_name }}
      source_repo: ${{ steps.base.outputs.source_repo }}
      ref: ${{ steps.base.outputs.ref }}

      registry: ${{ steps.base.outputs.registry }}
      platforms: ${{ steps.base.outputs.platforms }}

      docker_tag: ${{ steps.tag.outputs.docker_tag }}

      images_matrix: ${{ steps.matrix.outputs.images_matrix }}

      helm_enabled: ${{ steps.helm.outputs.helm_enabled }}
      charts_repo: ${{ steps.helm.outputs.charts_repo }}
      charts_ref: ${{ steps.helm.outputs.charts_ref }}
      chart_path: ${{ steps.helm.outputs.chart_path }}
      values_file: ${{ steps.helm.outputs.values_file }}
      update_app_version: ${{ steps.helm.outputs.update_app_version }}
      updates_json: ${{ steps.helm.outputs.updates_json }}

    steps:
      - uses: actions/checkout@v4

      - name: Install yq
        run: |
          set -euo pipefail
          sudo wget -qO /usr/local/bin/yq \
            https://github.com/mikefarah/yq/releases/download/v4.45.4/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - id: base
        name: Load base config
        env:
          REPO_NAME: ${{ github.event.client_payload.repo_name || github.event.inputs.repo_name }}
          SOURCE_REPO: ${{ github.event.client_payload.source_repo || github.event.inputs.source_repo }}
          REF: ${{ github.event.client_payload.ref || github.event.inputs.ref }}
        run: |
          set -euo pipefail

          yq -e ".projects.${REPO_NAME}" projects.yml >/dev/null

          get() {
            local v
            v="$(yq -r "$1" projects.yml)"
            [ "$v" = "null" ] && echo "$2" || echo "$v"
          }

          echo "repo_name=${REPO_NAME}" >> "$GITHUB_OUTPUT"
          echo "source_repo=${SOURCE_REPO}" >> "$GITHUB_OUTPUT"
          echo "ref=${REF}" >> "$GITHUB_OUTPUT"
          echo "registry=$(get ".projects.${REPO_NAME}.docker.registry" ghcr)" >> "$GITHUB_OUTPUT"
          echo "platforms=$(get ".projects.${REPO_NAME}.docker.platforms" linux/amd64)" >> "$GITHUB_OUTPUT"

      - id: tag
        name: Compute docker tag
        env:
          SOURCE_REPO: ${{ steps.base.outputs.source_repo }}
          REF: ${{ steps.base.outputs.ref }}
        run: |
          set -euo pipefail

          if echo "$REF" | grep -Eq '^v?[0-9]+\.[0-9]+\.[0-9]+'; then
            echo "docker_tag=$REF" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          SHA="$(git ls-remote "https://github.com/${SOURCE_REPO}.git" "${REF}" | awk '{print $1}')"
          if [ -z "$SHA" ]; then
            echo "Could not resolve ref '${REF}' in ${SOURCE_REPO}"
            exit 1
          fi

          echo "docker_tag=sha-${SHA:0:7}" >> "$GITHUB_OUTPUT"

      - id: matrix
        name: Build images matrix
        env:
          REPO_NAME: ${{ steps.base.outputs.repo_name }}
        run: |
          set -euo pipefail

          MATRIX="$(yq -o=json ".projects.${REPO_NAME}.docker.images" projects.yml)"

          python - <<'PY' > /tmp/matrix.json
          import json,sys
          data=json.loads(sys.stdin.read())
          inc=[]
          for k,v in data.items():
            inc.append({
              "image_key": k,
              "image_name": v["image_name"],
              "dockerfile_mode": v["dockerfile"]["mode"],
              "dockerfile_path": v["dockerfile"]["path"],
              "build_context": v["build"]["context"]
            })
          print(json.dumps({"include":inc}))
          PY
          <<EOF
          $MATRIX
          EOF

          {
            echo "images_matrix<<EOF"
            cat /tmp/matrix.json
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - id: helm
        name: Load helm config
        env:
          REPO_NAME: ${{ steps.base.outputs.repo_name }}
        run: |
          set -euo pipefail

          b() {
            case "$1" in
              true|True|TRUE|1|yes|YES|on|ON) echo "true" ;;
              *) echo "false" ;;
            esac
          }

          HELM_ENABLED_RAW="$(yq -r ".projects.${REPO_NAME}.helm.enabled" projects.yml)"
          UPDATE_APP_VERSION_RAW="$(yq -r ".projects.${REPO_NAME}.helm.update_app_version" projects.yml)"

          echo "helm_enabled=$(b "${HELM_ENABLED_RAW}")" >> "$GITHUB_OUTPUT"
          echo "charts_repo=$(yq -r ".projects.${REPO_NAME}.helm.charts_repo" projects.yml)" >> "$GITHUB_OUTPUT"
          echo "charts_ref=$(yq -r ".projects.${REPO_NAME}.helm.charts_ref" projects.yml)" >> "$GITHUB_OUTPUT"
          echo "chart_path=$(yq -r ".projects.${REPO_NAME}.helm.chart_path" projects.yml)" >> "$GITHUB_OUTPUT"
          echo "values_file=$(yq -r ".projects.${REPO_NAME}.helm.values_file" projects.yml)" >> "$GITHUB_OUTPUT"
          echo "update_app_version=$(b "${UPDATE_APP_VERSION_RAW}")" >> "$GITHUB_OUTPUT"

          {
            echo "updates_json<<EOF"
            yq -o=json ".projects.${REPO_NAME}.helm.updates" projects.yml
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

  build:
    needs: prepare
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.images_matrix) }}
    uses: NSerbin/gh-pipelines/.github/workflows/docker-build.yml@main
    with:
      registry: ${{ needs.prepare.outputs.registry }}
      ghcr-owner: nserbin

      repository-name: ${{ matrix.image_name }}
      docker-tag: ${{ needs.prepare.outputs.docker_tag }}
      docker-architecture: ${{ needs.prepare.outputs.platforms }}

      clone-source: true
      source-repo: ${{ needs.prepare.outputs.source_repo }}
      source-ref: ${{ needs.prepare.outputs.ref }}

      dockerfile-mode: ${{ matrix.dockerfile_mode }}
      dockerfile-path: ${{ matrix.dockerfile_path }}
      build-context: ${{ matrix.build_context }}

      # ðŸ‘‡ ESTE ES EL INPUT CORRECTO (NO "linter-fail")
      linter-no-fail: "true"
    secrets: inherit

  update_helm:
    needs: [prepare, build]
    if: ${{ needs.prepare.outputs.helm_enabled == 'true' }}
    uses: NSerbin/gh-pipelines/.github/workflows/helm-update-image-tag.yml@main
    with:
      charts_repo: ${{ needs.prepare.outputs.charts_repo }}
      charts_ref: ${{ needs.prepare.outputs.charts_ref }}
      chart_path: ${{ needs.prepare.outputs.chart_path }}
      values_file: ${{ needs.prepare.outputs.values_file }}

      image_tag: ${{ needs.prepare.outputs.docker_tag }}
      updates_json: ${{ needs.prepare.outputs.updates_json }}
      update_app_version: ${{ needs.prepare.outputs.update_app_version }}

      commit_message: "chore(${{
        needs.prepare.outputs.repo_name
      }}): bump images"
    secrets: inherit
